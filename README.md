# Noir Gates Diff Reporter

- Easily compare gates reports generated by Nargo automatically on each of your Pull Requests!

## Getting started

### Automatically generate a gas report diff on every PR

Add a workflow (`.github/workflows/noir-gas-diff.yml`):

```yaml
name: Report gates diff

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  compare_gas_reports:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install Nargo
        uses: noir-lang/noirup@v0.1.2
        with:
          toolchain: 0.11.0

      # Add any step generating a gas report to a temporary file named gasreport.ansi. For example:
      - name: Generate gates report
        run: nargo info --json > gasreport.json # <- this file name should be unique in your repository!
       
      - name: Compare gates reports
        uses: TomAFrench/noir-gates-diff@v0.0.1
        with:
          summaryQuantile: 0.9 # only display the 10% most significant gas diffs in the summary (defaults to 20%)
          id: gates_diff

      - name: Add gates diff to sticky comment
        if: github.event_name == 'pull_request' || github.event_name == 'pull_request_target'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          # delete the comment in case changes no longer impact gas costs
          delete: ${{ !steps.gas_diff.outputs.markdown }}
          message: ${{ steps.gas_diff.outputs.markdown }}
```

> :information_source: **An error will appear at first run!**<br/>
> 🔴 <em>**Error:** No workflow run found with an artifact named "main.gasreport.json"</em><br/>
> As the action is expecting a comparative file stored on the base branch and cannot find it (because the action never ran on the target branch and thus has never uploaded any gas report)

---

## How it works

Everytime somebody opens a Pull Request, the action expects [Noir's](https://github.com/noir-lang/noir) `nargo` to generate a gates report to a temporary file (named `gatereport.json` by default).

Once generated, the action will fetch the comparative gates report stored as an artifact from previous runs; parse & compare them, storing the results in the action's outputs as shell and as markdown.

You can then do whatever you want with the results!

> **Our recommandation:** Automatically submit a sticky comment displaying the gas diff!

---

## Options

### `report` _{string}_

This should correspond to the path of a file where the output of forge's gas report has been logged.
Only necessary when generating multiple gas reports on the same repository.

⚠️ Make sure this file uniquely identifies a gas report, to avoid messing up with a gas report of another workflow on the same repository!

_Defaults to: `gasreport.ansi`_

### `base` _{string}_

The gas diff reference branch name, used to fetch the previous gas report to compare the freshly generated gas report to.

_Defaults to: `${{ github.base_ref || github.ref_name }}`_

### `head` _{string}_

The gas diff target branch name, used to upload the freshly generated gas report.

_Defaults to: `${{ github.head_ref || github.ref_name }}`_

### `token` _{string}_

The github token allowing the action to upload and download gas reports generated by foundry. You should not need to customize this, as the action already has access to the default Github Action token.

_Defaults to: `${{ github.token }}`_

### `header` _{string}_

The top section displayed in the markdown output. Can be used to identify multiple gas diffs in the same PR or add metadata/information to the markdown output.

_Defaults to:_

```markdown
# Changes to circuit sizes
```

### `summaryQuantile` _{number}_

The quantile threshold to filter avg gas cost diffs to display in the summary top section.

_Defaults to: `0.8`_

## ⚠️ Known limitations

> **Library gates reports**<br/>
> Nargo does not generate library gates reports. You need to wrap their usage in a contract calling the library to be able to compare gas costs of calling the library.

This repository is maintained independently from [Nargo](https://github.com/noir-lang/noir) and may not work as expected with all versions of `nargo`.
